<f:view xmlns="http://www.w3.org/1999/xhtml"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:eye="http://jsfcomponents.eyeline.mobi"
        xmlns:ips="http://java.sun.com/jsf/composite/ipsc"
        xmlns:ipsc="http://ips.eyeline.mobi"
        xmlns:c="http://java.sun.com/jsp/jstl/core">

  <ui:composition template="/templates/main.xhtml">
    <ui:define name="head">
      <h:outputStylesheet library="pages" name="surveys/settings.less"/>
      <h:outputStylesheet library="styles" name="font-awesome/css/font-awesome.min.css"/>

      <h:outputScript library="pages" name="surveys/settings.js" target="head"/>
      <h:outputScript library="ipsc" name="select-short-menu.js" target="head"/>
    </ui:define>

    <ui:define name="scripts">
      <h:outputScript>
        page.init();

        $(function() {

          if ("#{surveySettingsController.errorId}" == 'settingsDialog'
              || $("#newSurveyStartDate").hasClass("validationError")
              || $("#newSurveyEndDate").hasClass("validationError") ) {
            page.onEditSettingsClick();
          } else if ("#{surveySettingsController.errorId}" == 'endMessageDialog') {
            page.onEditEndMessageClick();
          } else if ("#{surveySettingsController.errorId}" == 'questionModificationDialog') {
            page.onQuestionModificationDialog();
          } else if ("#{surveySettingsController.errorId}" == 'extLinkModificationDialog') {
            page.onExtLinkModificationDialog();
          } else if ("#{surveySettingsController.errorId}" == 'questionDeleteDialog') {
            page.onQuestionDeleteDialog();
          } else if ("#{surveySettingsController.errorId}" == 'extLinkDeleteDialog') {
            page.onExtLinkDeleteDialog();
          } else if ("#{surveySettingsController.errorId}" == 'surveyPreviewDialog') {
            page.onPreviewClick();
          } else if ("#{surveySettingsController.errorId}" == 'deleteDialog') {
            page.showSurveyDeleteDialog();
          }

          if (#{surveySettingsController.previewSentOk}) {
            ips.message.info("#{bundle['survey.settings.preview.success']}");
          }

          $('form').attr('action',
              '/pages/surveys/settings.faces?id=#{surveySettingsController.surveyId}');

          page.setTreeLabels(
              "#{bundle['survey.settings.tree.zoom.in']}",
              "#{bundle['survey.settings.tree.zoom.out']}",
              "#{bundle['survey.settings.tree.zoom.reset']}"
          );

          var treeComponent = jsfc('questionsTree');
          if (treeComponent) {
            treeComponent.show();
          }

          jsfc('tabs').bind('activate', function (event, data) {
            ips.$byId('openedGraph').val(data.index == 1);
          });
        });
      </h:outputScript>

    </ui:define>

    <ui:define name="content">
      <h:form enctype="multipart/form-data" id="content" prependId="false">

        <h:inputHidden id="id" value="#{surveySettingsController.surveyId}"/>
        <h:inputHidden id="questionId" value="#{surveySettingsController.questionId}"/>
        <h:inputHidden id="extLinkId" value="#{surveySettingsController.extLinkId}"/>

        <h:inputHidden id="settingsStartDate" value="#{surveySettingsController.settingsStartDate}"/>
        <h:inputHidden id="settingsEndDate" value="#{surveySettingsController.settingsEndDate}"/>
        <h:inputHidden id="openedGraph" value="#{surveySettingsController.openedGraph}"/>

        <h:panelGroup layout="block" styleClass="border-shadow">

          <h:panelGrid columns="2" styleClass="page-header">
            <h:panelGroup layout="block">
              <h:outputText value="ID-#{surveySettingsController.survey.id}"
                            style="font-weight:normal"/>
              <h:outputText value="#{surveySettingsController.survey.details.title}"
                            style="margin-left: 20px"/>
            </h:panelGroup>
            <h:panelGroup styleClass="page-header-buttons">
              <h:outputLink value="/pages/surveys/index.faces"
                            styleClass="button-heading">
                <h:outputText value="&lt; #{bundle['survey.details.link.back']}"/>
              </h:outputLink>
              <h:outputLink id="deleteButton"
                            value="#"
                            styleClass="button-heading"
                            onclick="page.showSurveyDeleteDialog()"
                            style="margin-left: 5px;"
                            rendered="#{userSession.surveyModificationAllowed}">
                <h:outputText value="#{bundle['survey.details.delete']}"/>
              </h:outputLink>
            </h:panelGroup>
          </h:panelGrid>

          <h:panelGroup layout="block" styleClass="tabs">
            <h:panelGrid columns="4"
                         columnClasses="tab_active,tab,tab,tab"
                         style="width:auto">
              <h:outputLink value="#">
                <h:outputText value="#{bundle['survey.details.tab.settings']}"/>
              </h:outputLink>
              <h:outputLink value="results.faces?id=#{surveySettingsController.surveyId}">
                <h:outputText value="#{bundle['survey.details.tab.results']}"/>
              </h:outputLink>
              <h:panelGroup layout="block">
                <h:outputLink value="#">
                  <h:outputText value="#{bundle['survey.details.tab.stats']}"/> &#x25BE;
                </h:outputLink>
                <ul>
                  <li>
                    <h:outputLink value="statistics-results.faces?id=#{surveyResultsController.surveyId}">
                      <h:outputText value="#{bundle['survey.details.tab.stats.response']}"/>
                    </h:outputLink>
                  </li>
                  <li>
                    <h:outputLink value="statistics-deliveries.faces?id=#{surveyResultsController.surveyId}">
                      <h:outputText value="#{bundle['survey.details.tab.stats.delivery']}"/>
                    </h:outputLink>
                  </li>
                  <li>
                    <h:outputLink value="statistics-c2s.faces?id=#{surveyResultsController.surveyId}">
                      <h:outputText value="#{bundle['survey.details.tab.stats.c2s']}"/>
                    </h:outputLink>
                  </li>
                </ul>
              </h:panelGroup>
              <h:outputLink value="invitations.faces?id=#{surveySettingsController.surveyId}">
                <h:outputText value="#{bundle['survey.details.tab.invites']}"/>
              </h:outputLink>
            </h:panelGrid>
          </h:panelGroup>

          <h:panelGroup layout="block" styleClass="page-body">

            <!--
                  Survey settings
            -->

            <eye:collapsingGroup opened="true" id="groupSettings">
              <f:facet name="header">
                <h:panelGroup>
                  <h:outputText value="#{bundle['survey.settings.settings']}"/>
                  <h:commandLink value="#{bundle['survey.settings.modify']}"
                                 onclick="return page.onEditSettingsClick();"
                                 styleClass="modify-left"
                                 rendered="#{userSession.surveyModificationAllowed}"/>
                </h:panelGroup>
              </f:facet>
              <h:panelGroup>

                <h:panelGrid id="settingsDisplay"
                             styleClass="settingsDisplay"
                             columns="2"
                             columnClasses="settings-left,settings-right">
                  <!-- Title -->
                  <h:outputLabel value="#{bundle['survey.properties.title']}"
                                 for="surveyTitle"/>
                  <h:outputText id="surveyTitle"
                                value="#{surveySettingsController.persistedSurvey.details.title}"/>

                  <!-- Start date -->
                  <h:outputLabel value="#{bundle['survey.properties.period.start']}"
                                 for="surveyStartDate"/>
                  <h:outputText id="surveyStartDate"
                                value="#{surveySettingsController.persistedSurvey.startDate}">
                    <f:convertDateTime type="both" dateStyle="short" timeZone="#{userSession.timeZone}"/>
                  </h:outputText>

                  <!-- End date -->
                  <h:outputLabel value="#{bundle['survey.properties.period.end']}"
                                 for="surveyEndDate"/>
                  <h:outputText id="surveyEndDate"
                                value="#{surveySettingsController.persistedSurvey.endDate}">
                    <f:convertDateTime type="both" dateStyle="short" timeZone="#{userSession.timeZone}"/>
                  </h:outputText>

                  <!-- Client -->
                  <h:outputLabel value="#{bundle['survey.properties.client']}"
                                 for="client"/>
                  <h:outputText id="client"
                                value="#{surveySettingsController.persistedSurvey.client.fullName}"/>

                  <!-- Poll external URL -->
                  <h:outputLabel value="#{bundle['survey.external.url']}"
                                 for="externalUrl"
                                 rendered="#{userSession.managerRole}"/>
                  <h:outputText id="externalUrl"
                                value="#{surveySettingsController.surveyUrl}"
                                rendered="#{userSession.managerRole}"/>

                  <!-- Poll internal URL -->
                  <h:outputLabel value="#{bundle['survey.internal.url']}"
                                 for="internalUrl"
                                 rendered="#{userSession.managerRole}"/>
                  <h:outputText id="internalUrl"
                                value="#{surveySettingsController.surveyInternalUrl}"
                                rendered="#{userSession.managerRole}"/>
                </h:panelGrid>

                <h:panelGroup styleClass="settingsDisplay"
                              rendered="#{surveySettingsController.showDisabled}">
                  <h:outputText styleClass="noCouponsError"
                                value="#{bundle['survey.settings.end.message.coupon.exhausted']}"/>
                </h:panelGroup>

                <h:panelGroup id="settingsDialog"
                              style="display: none"
                              rendered="#{userSession.surveyModificationAllowed}">
                  <h:panelGrid columns="2" columnClasses="settings-left,none" >
                    <h:outputLabel value="#{bundle['survey.properties.title']}"
                                   for="newSurveyTitle"/>
                    <eye:inputText id="newSurveyTitle"
                                   maxlength="45"
                                   value="#{surveySettingsController.survey.details.title}"/>

                    <h:outputLabel value="#{bundle['survey.properties.period']}" for="newSurveyStartDate"/>
                    <h:panelGrid id="dates" columns="3" cellpadding="0"  >
                      <eye:inputDate id="newSurveyStartDate"
                                     inputTime="true"
                                     converterMessage="#{bundle['survey.validation.date.format']}"
                                     value="#{surveySettingsController.survey.startDate}">
                        <f:convertDateTime timeZone="#{userSession.timeZone}"/>
                      </eye:inputDate>

                      <h:outputText style="margin:0 10px 0 0;" value=" â€” "/>
                      <eye:inputDate id="newSurveyEndDate"
                                     inputTime="true"
                                     converterMessage="#{bundle['survey.validation.date.format']}"
                                     value="#{surveySettingsController.survey.endDate}">
                        <f:convertDateTime timeZone="#{userSession.timeZone}"/>
                      </eye:inputDate>
                    </h:panelGrid>

                    <h:outputLabel value="#{bundle['survey.properties.client']}"
                                   for="clients"/>
                    <h:selectOneMenu id="clients"
                                     value="#{surveySettingsController.newSurveyClientId}"
                                     style="margin-left: 0; margin-right: 0">
                      <f:selectItems value="#{clientController.getClients(userSession.currentUser)}" />
                    </h:selectOneMenu>
                  </h:panelGrid>

                  <eye:buttons>
                    <eye:button>
                      <h:commandLink styleClass="button-green btnSubmit"
                                     value="#{bundle['survey.settings.save']}"
                                     action="#{surveySettingsController.saveSettings}">
                        <f:param name="errorId" value="settingsDialog"/>
                      </h:commandLink>
                    </eye:button>
                    <eye:button>
                      <h:outputLink styleClass="button-green"
                                    value="#"
                                    onclick="return page.onEditSettingsCancel();">
                        <h:outputText value="#{bundle['survey.create.button.cancel']}"/>
                      </h:outputLink>
                    </eye:button>
                    <eye:space/>
                  </eye:buttons>
                </h:panelGroup>

              </h:panelGroup>
            </eye:collapsingGroup>


            <!--
                Access number settings.
            -->

            <eye:collapsingGroup opened="true" id="groupAccessNumbers">
              <f:facet name="header">
                <h:panelGroup>
                  <h:outputText value="#{bundle['survey.list.table.access.numbers']}"/>
                  <h:commandLink value="#{bundle['survey.settings.modify']}"
                                 onclick="return page.onEditAccessNumbersClick();"
                                 styleClass="modify-left"
                                 rendered="#{userSession.surveyModificationAllowed}"/>
                </h:panelGroup>
              </f:facet>
              <h:panelGroup>
                <h:panelGrid id="accessNumbersDisplay"
                             styleClass="accessNumbersDisplay"
                             columns="2"
                             columnClasses="settings-left,settings-right">

                  <!-- List of numbers -->
                  <h:outputLabel value="#{bundle['survey.list.table.access.numbers.list']}"
                                 for="accessNumbers"/>
                  <h:outputText id="accessNumbers"
                                value="#{surveySettingsController.readableAccessNumbers}"/>
                </h:panelGrid>

                <h:panelGroup id="accessNumbersDialog"
                              style="display: none"
                              layout="block"
                              rendered="#{userSession.surveyModificationAllowed}">

                  <eye:dynamicTable value="#{surveySettingsController.accessNumbersModel}"
                                    tableClass="table-narrow"
                                    dragRows="false">
                    <eye:selectColumn name="number"
                                      values="#{surveySettingsController.availableAccessNumbers}"
                                      var="var"
                                      itemLabel="#{var.label}"
                                      itemValue="#{var.value}"
                                      itemDescription="#{var.description}"
                                      itemDisabled="#{var.disabled}"
                                      allowEditAfterAdd="true"
                                      uniqueValues="true"/>
                  </eye:dynamicTable>

                  <eye:buttons>
                    <eye:button>
                      <h:commandLink styleClass="button-green btnSubmit"
                                     value="#{bundle['survey.settings.save']}"
                                     action="#{surveySettingsController.saveAccessNumbers}">
                        <f:param name="errorId" value="accessNumbersDialog"/>
                      </h:commandLink>
                    </eye:button>
                    <eye:button>
                      <h:outputLink styleClass="button-green"
                                    value="#"
                                    onclick="return page.onEditAccessNumbersCancel();">
                        <h:outputText value="#{bundle['survey.create.button.cancel']}"/>
                      </h:outputLink>
                    </eye:button>
                    <eye:space/>
                  </eye:buttons>
                </h:panelGroup>

              </h:panelGroup>
            </eye:collapsingGroup>


            <!--
                Telegram settings.
            -->

            <eye:collapsingGroup opened="true" id="groupTelegram">
              <f:facet name="header">
                <h:panelGroup>
                  <h:outputText value="#{bundle['survey.properties.telegram.token']}"/>
                  <h:commandLink value="#{bundle['survey.settings.modify']}"
                                 onclick="return page.onEditTelegramClick()();"
                                 styleClass="modify-left"
                                 rendered="#{userSession.surveyModificationAllowed}"/>
                </h:panelGroup>
              </f:facet>
              <h:panelGroup>
                <h:panelGrid id="telegramDisplay"
                             styleClass="telegramDisplay"
                             columns="2"
                             columnClasses="settings-left,settings-right">

                  <h:outputLabel value="#{bundle['survey.properties.telegram.token.label']}"
                                 for="telegramToken"/>
                  <h:outputText id="telegramToken"
                                value="#{surveySettingsController.readableTelegramToken}"/>

                  <h:outputLabel value="#{bundle['survey.properties.telegram.username']}"
                                 for="telegramUsername"
                                 rendered="#{not empty surveySettingsController.survey.statistics.telegramUsername}"/>
                  <h:outputText id="telegramUsername"
                                value="#{surveySettingsController.survey.statistics.telegramUsername}"
                                rendered="#{not empty surveySettingsController.survey.statistics.telegramUsername}"/>
                </h:panelGrid>

                <h:panelGroup id="telegramDialog"
                              style="display: none"
                              layout="block"
                              rendered="#{userSession.surveyModificationAllowed}">

                  <h:panelGrid columns="2"
                               columnClasses="settings-left,settings-right">

                    <h:outputLabel value="#{bundle['survey.properties.telegram.token.label']}"
                                   for="newTelegramToken"/>
                    <eye:inputText id="newTelegramToken"
                                   maxlength="1024"
                                   value="#{surveySettingsController.survey.statistics.telegramToken}"/>
                  </h:panelGrid>

                  <eye:buttons>
                    <eye:button>
                      <h:commandLink styleClass="button-green btnSubmit"
                                     value="#{bundle['survey.settings.save']}"
                                     action="#{surveySettingsController.saveTelegramToken}">
                        <f:param name="errorId" value="telegramDialog"/>
                      </h:commandLink>
                    </eye:button>
                    <eye:button>
                      <h:outputLink styleClass="button-green"
                                    value="#"
                                    onclick="return page.onEditTelegramCancel();">
                        <h:outputText value="#{bundle['survey.create.button.cancel']}"/>
                      </h:outputLink>
                    </eye:button>
                    <eye:space/>
                  </eye:buttons>
                </h:panelGroup>

              </h:panelGroup>
            </eye:collapsingGroup>

            <eye:collapsingGroup opened="true" id="questionsList">
              <f:facet name="header">
                <h:panelGroup>
                  <h:outputText value="#{bundle['survey.settings.questions']}"/>
                </h:panelGroup>
              </f:facet>
              <h:panelGroup>
                <h:outputText rendered="#{empty surveySettingsController.persistedSurvey.activeQuestions}"
                              value="#{bundle['survey.settings.no.pages']}"
                              styleClass="placeholder"/>
              </h:panelGroup>
              <eye:tabs id="tabs" autoSelectClass="opened" rendered="#{!empty surveySettingsController.persistedSurvey.activeQuestions}">
                <eye:tab id="questions" label="#{bundle['survey.settings.questions.tabs.questions']}">

                  <eye:collapsingGroup opened="true" id="groupEditorQuestions">
                    <f:facet name="header">
                      <h:panelGroup>
                        <h:outputText value="#{bundle['survey.settings.questions.questions']}"/>
                      </h:panelGroup>
                    </f:facet>

                    <h:panelGroup rendered="#{empty surveySettingsController.persistedSurvey.activeQuestions}">
                      <h:outputText value="#{bundle['survey.settings.no.questions']}"
                                    styleClass="placeholder"/>
                    </h:panelGroup>

                    <h:panelGroup>
                      <ui:repeat value="#{surveySettingsController.persistedSurvey.activeQuestions}"
                                 var="question">
                        <h:panelGrid columns="1" styleClass="question">

                          <!-- Question header -->
                          <f:facet name="header">
                            <h:panelGrid columns="2" style="background-color: #F0F0F0;">
                              <h:panelGroup>
                                <h:outputText value="#{question.activeIndex + 1}. "
                                              style="padding-right: 5px"/>
                                <h:outputText value="#{question.title} "/>
                              </h:panelGroup>
                              <h:panelGroup rendered="#{userSession.surveyModificationAllowed}">
                                <h:commandLink value="#{bundle['survey.details.delete']}"
                                               styleClass="modify"
                                               action="#{surveySettingsController.beforeDeleteQuestion(question.id)}"/>
                                <h:commandLink value="#{bundle['survey.settings.modify']}"
                                               action="#{surveySettingsController.modifyQuestion(question.id)}"
                                               styleClass="modify"/>
                              </h:panelGroup>
                            </h:panelGrid>
                          </f:facet>

                          <!-- Question body -->
                          <h:panelGrid columns="2" columnClasses="columnOptionsList,columnSegmentation">

                            <!-- Options list -->
                            <h:panelGroup>
                              <h:panelGroup styleClass="defaultOption" layout="block">
                                <h:outputText rendered="#{question.enabledDefaultAnswer and question.defaultPage != null}"
                                              value="#{bundle['survey.settings.question.default.question']} &#8594; #{surveySettingsController.getPagePrefix(question.defaultPage)} #{question.defaultPage.activeIndex + 1} (#{question.defaultPage.briefTitle})"
                                              styleClass="option-label"/>
                                <h:outputText rendered="#{question.enabledDefaultAnswer and question.defaultPage == null}"
                                              value="#{bundle['survey.settings.question.default.question']} &#8594; #{bundle['question.option.terminal.list.label']}"
                                              styleClass="option-label"/>
                                <h:outputText rendered="#{!question.enabledDefaultAnswer}"
                                              value="#{bundle['survey.settings.question.default.question']} #{bundle['survey.settings.question.default.question.disabled']}"
                                              styleClass="option-label"/>

                              </h:panelGroup>

                              <h:outputText rendered="#{empty question.activeOptions}"
                                            value="#{bundle['survey.settings.question.options.not.specified']}"
                                            styleClass="placeholder"/>

                              <h:dataTable var="option"
                                           value="#{question.activeOptions}"
                                           rendered="#{not empty question.activeOptions}"
                                           style="padding-left: 20px">
                                <h:column>
                                  <h:outputText value="#{option.activeIndex + 1}. "
                                                styleClass="option-number"/>
                                  <h:outputText value="#{option.answer}"/>
                                  <h:outputText value="&#8594; #{bundle['question.option.terminal.list.label']}"
                                                rendered="#{option.nextPage == null}"
                                                styleClass="option-label"/>
                                  <h:outputText value="&#8594; #{surveySettingsController.getPagePrefix(option.nextPage)} #{option.nextPage.activeIndex+1} (#{option.nextPage.briefTitle})"
                                                rendered="#{option.nextPage != null}"
                                                styleClass="option-label"/>
                                </h:column>
                              </h:dataTable>
                            </h:panelGroup>

                            <!-- Segmentation -->
                            <h:panelGroup layout="block" id="segmentation">
                              <h:panelGrid columns="2">
                                <h:outputLabel for="symbols"
                                               value="#{bundle['survey.settings.question.symbols']}:"/>
                                <h:outputText id="symbols"
                                              value="#{segmentationService.getSegmentationInfo(question).symbolsCount}"/>

                                <h:outputLabel for="segments"
                                               value="#{bundle['survey.settings.question.segments']}:"/>
                                <h:outputText id="segments"
                                              value="#{segmentationService.getSegmentationInfo(question).segmentsCount}"/>

                                <h:outputLabel for="perSegment"
                                               value="#{bundle['survey.settings.question.symbols.per.segment']}:"/>
                                <h:outputText id="perSegment"
                                              value="#{segmentationService.getSegmentationInfo(question).maxSymbolsPerSegment}"/>
                              </h:panelGrid>
                            </h:panelGroup>
                          </h:panelGrid>

                        </h:panelGrid>
                      </ui:repeat>
                    </h:panelGroup>
                  </eye:collapsingGroup>

                  <eye:collapsingGroup opened="true" id="groupEditorExtLinks">
                    <f:facet name="header">
                      <h:panelGroup>
                        <h:outputText value="#{bundle['survey.settings.questions.ext.links']}"/>
                      </h:panelGroup>
                    </f:facet>
                    <h:panelGroup>

                      <h:panelGroup rendered="#{empty surveySettingsController.persistedSurvey.activeExtLinkPages}">
                        <h:outputText value="#{bundle['survey.settings.no.ext.links']}"
                                      styleClass="placeholder"/>
                      </h:panelGroup>

                      <ui:repeat value="#{surveySettingsController.persistedSurvey.activeExtLinkPages}"
                                 var="extLink">

                        <h:panelGrid columns="1" styleClass="extLink">

                          <!-- Item header -->
                          <f:facet name="header">
                            <h:panelGrid columns="2" style="background-color: #F0F0F0;">
                              <h:panelGroup>
                                <h:outputText value="#{extLink.activeIndex + 1}. "
                                              style="padding-right: 5px"/>
                                <h:outputText value="#{extLink.title} "/>
                              </h:panelGroup>
                              <h:panelGroup rendered="#{userSession.surveyModificationAllowed}">
                                <h:commandLink value="#{bundle['survey.details.delete']}"
                                               styleClass="modify"
                                               action="#{surveySettingsController.beforeDeleteExtLink(extLink.id)}"/>
                                <h:commandLink value="#{bundle['survey.settings.modify']}"
                                               action="#{surveySettingsController.modifyExtLink(extLink.id)}"
                                               styleClass="modify"/>
                              </h:panelGroup>
                            </h:panelGrid>
                          </f:facet>

                          <h:panelGrid columns="2" columnClasses="columnOptionsList,columnSegmentation">
                            <h:panelGroup styleClass="defaultOption" layout="block">
                              <h:outputText value="#{bundle['survey.settings.ext.link.modify.service.url']}:"
                                            styleClass="option-label" style="padding-right: 5px"/>
                              <h:outputText value="#{extLink.serviceUrl}"/>
                            </h:panelGroup>
                          </h:panelGrid>
                        </h:panelGrid>
                      </ui:repeat>
                    </h:panelGroup>
                  </eye:collapsingGroup>

                </eye:tab>

                <eye:tab id="graph" label="#{bundle['survey.settings.questions.tabs.graphs']}">
                  <ipsc:tree id="questionsTree"
                             value="#{surveySettingsController.questionsGraph}"
                             height="600"
                             width="1162"
                             direction="TB"/>
                  <c:if test="#{surveySettingsController.openedGraph}">
                    <!-- Marks that last active tab is the graph. -->
                    <span id="graphFlag" class="opened"/>
                  </c:if>
                  <h:panelGroup layout="block" styleClass="italicStyle">
                    <h:outputText value="#{bundle['survey.settings.questions.tabs.graphs.legend']}"/>
                  </h:panelGroup>
                </eye:tab>

              </eye:tabs>

                    <h:panelGrid columns="2" columnClasses="previewLeft,previewRight">
                      <h:panelGroup>
                        <eye:buttons>
                          <eye:button>
                            <h:commandLink value="#{bundle['survey.settings.question.add']}"
                                           action="#{surveySettingsController.modifyQuestion(null)}"
                                           styleClass="button-green" style="width: 1px"
                                           rendered="#{userSession.surveyModificationAllowed}"/>
                          </eye:button>
                          <eye:button id="btnAddExtLink" visible="#{empty surveySettingsController.persistedSurvey.activeQuestions ? false : true}">
                            <h:commandLink value="#{bundle['survey.settings.ext.link.add']}"
                                           action="#{surveySettingsController.modifyExtLink(null)}"
                                           styleClass="button-green" style="width: 100%"
                                           rendered="#{userSession.surveyModificationAllowed}"/>
                          </eye:button>
                        </eye:buttons>
                      </h:panelGroup>

                      <eye:buttons
                          rendered="#{not empty surveySettingsController.survey.activeQuestions and
                                      empty surveySettingsController.survey.statistics.telegramToken}">
                        <eye:button>
                          <h:outputLink styleClass="button-green"
                                        onclick="return page.onPreviewClick();">
                            <h:outputText value="#{bundle['survey.settings.preview']}"/>
                          </h:outputLink>
                        </eye:button>
                      </eye:buttons>

                      <eye:menubar label="#{bundle['survey.settings.preview']}"
                                   menuBarStyle="button-green"
                                   subMenuStyle="preview-submenu"
                                   rendered="#{not empty surveySettingsController.survey.activeQuestions and
                                               not empty surveySettingsController.survey.statistics.telegramToken}">
                        <eye:menubaritem>
                          <h:outputLink styleClass="button-green"
                                        onclick="return page.onPreviewClick();">
                            <h:outputText value="#{bundle['survey.settings.preview.push']}"/>
                          </h:outputLink>
                        </eye:menubaritem>

                        <eye:menubaritem>
                          <h:outputLink styleClass="button-green"
                                        onclick="return page.onTelegramPreviewClick();">
                            <h:outputText value="#{bundle['survey.settings.preview.push.telegram']}"/>
                          </h:outputLink>
                        </eye:menubaritem>
                      </eye:menubar>

                    </h:panelGrid>

            </eye:collapsingGroup>

            <eye:collapsingGroup opened="true" id="groupEndMessage">
              <f:facet name="header">
                <h:panelGroup>
                  <h:outputText value="#{bundle['survey.settings.end.message']}"/>
                  <h:commandLink value="#{bundle['survey.settings.modify']}"
                                 onclick="return page.onEditEndMessageClick();"
                                 styleClass="modify-left"
                                 rendered="#{userSession.surveyModificationAllowed}"/>
                </h:panelGroup>
              </f:facet>
              <h:panelGroup>

                <h:panelGroup id="endMessageView">
                  <h:panelGrid id="settingsDisplayEndMessage"
                               columns="2"
                               columnClasses="settings-left,settings-right">

                    <h:outputText value="#{bundle['survey.settings.end.message.title.ussd']}"/>

                    <h:panelGroup>
                      <h:outputText id="surveyEndText"
                                    rendered="#{surveySettingsController.persistedSurvey.details.endText != null}"
                                    value="#{surveySettingsController.persistedSurvey.details.endText}"/>
                      <h:outputText id="surveyEndTextPlaceholder"
                                    rendered="#{surveySettingsController.persistedSurvey.details.endText == null}"
                                    value="#{bundle['survey.settings.not.specified']}"
                                    styleClass="placeholder"/>
                    </h:panelGroup>

                    <h:outputText value="#{bundle['survey.settings.end.message.title.sms']}"/>

                    <h:panelGroup>
                      <h:outputText value="#{surveySettingsController.persistedSurvey.details.endSmsText}"
                                    rendered="#{surveySettingsController.persistedSurvey.details.endSmsEnabled}"/>

                      <h:outputText rendered="#{not surveySettingsController.persistedSurvey.details.endSmsEnabled}"
                                    value="#{bundle['survey.settings.not.specified']}"
                                    styleClass="placeholder"/>
                    </h:panelGroup>

                    <!-- Originating address disabled (ips-228) -->
                    <h:outputText value="#{bundle['survey.settings.end.message.title.sms.number']}"
                                  rendered="#{surveySettingsController.persistedSurvey.details.endSmsEnabled and false}"/>
                    <h:outputText value="#{surveySettingsController.persistedSurvey.details.endSmsFrom}"
                                  rendered="#{surveySettingsController.persistedSurvey.details.endSmsEnabled and false}"/>

                    <h:outputText value="#{bundle['survey.settings.end.message.coupon.format']}"
                                  rendered="#{surveySettingsController.couponEnabled}"/>
                    <h:outputText value="#{surveySettingsController.generatorName}"
                                  rendered="#{surveySettingsController.couponEnabled}"/>

                    <h:outputText value="#{bundle['survey.settings.end.message.coupon.length']}"
                                  rendered="#{surveySettingsController.couponEnabled}"/>
                    <h:outputText value="#{surveySettingsController.persistedSurvey.activePattern.length}"
                                  rendered="#{surveySettingsController.couponEnabled}"/>

                    <h:outputText value="#{bundle['survey.settings.end.message.coupon.sent']}"
                                  rendered="#{surveySettingsController.couponEnabled}"/>
                    <h:outputText value="#{surveySettingsController.couponsSent}"
                                  rendered="#{surveySettingsController.couponEnabled}"/>

                    <h:outputText value="#{bundle['survey.settings.end.message.coupon.available']}"
                                  rendered="#{surveySettingsController.couponEnabled}"/>

                    <h:panelGroup rendered="#{surveySettingsController.showWarning}">
                      <h:outputText value="#{surveySettingsController.couponsAvailable}"
                                    styleClass="noCouponsError"
                                    rendered="#{surveySettingsController.couponEnabled}"/>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{not surveySettingsController.showWarning}">
                      <h:outputText value="#{surveySettingsController.couponsAvailable}"
                                    rendered="#{surveySettingsController.couponEnabled}"/>
                    </h:panelGroup>


                  </h:panelGrid>
                </h:panelGroup>

                <h:panelGroup id="endMessageDialog" style="display: none">
                  <h:panelGrid columns="2" columnClasses="settings-left,none">

                    <h:outputLabel value="#{bundle['survey.settings.end.message.title.ussd']}"
                                   for="endText"/>
                    <eye:inputText id="endText"
                                   maxlength="70"
                                   value="#{surveySettingsController.survey.details.endText}"/>

                    <h:outputLabel value="#{bundle['survey.settings.end.message.title.sms.enabled']}"
                                   for="endSmsEnabled"/>
                    <h:selectOneMenu id="endSmsEnabled"
                                     value="#{surveySettingsController.endSmsType}"
                                     onchange="page.onEndSmsEnabledChange(this);">
                      <f:selectItem itemValue="DISABLED"
                                    itemLabel="#{bundle['survey.settings.end.message.title.sms.enabled.no']}"/>
                      <f:selectItem itemValue="SMS"
                                    itemLabel="#{bundle['survey.settings.end.message.title.sms.enabled.sms']}"/>
                      <f:selectItem itemValue="COUPON"
                                    itemLabel="#{bundle['survey.settings.end.message.title.sms.enabled.coupon']}"/>
                    </h:selectOneMenu>
                  </h:panelGrid>

                  <h:panelGrid id="couponDetails"
                               columns="2"
                               columnClasses="settings-left,none">
                    <h:outputLabel value="#{bundle['survey.settings.end.message.coupon.format']}"
                                   for="couponFormat"/>
                    <h:selectOneMenu id="couponFormat"
                                     value="#{surveySettingsController.currentPatternMode}">
                      <f:selectItems value="#{surveySettingsController.patternModes}"/>
                    </h:selectOneMenu>

                    <h:outputLabel value="#{bundle['survey.settings.end.message.coupon.length']}"
                                   for="couponLength"/>
                    <h:selectOneMenu id="couponLength"
                                     value="#{surveySettingsController.currentPatternLength}">
                      <f:selectItem itemValue="4" itemLabel="4"/>
                      <f:selectItem itemValue="5" itemLabel="5"/>
                      <f:selectItem itemValue="6" itemLabel="6"/>
                      <f:selectItem itemValue="7" itemLabel="7"/>
                      <f:selectItem itemValue="8" itemLabel="8"/>
                    </h:selectOneMenu>

                  </h:panelGrid>

                  <h:panelGrid columns="2"
                               columnClasses="settings-left,none"
                               styleClass="endSmsDetails">
                    <h:outputLabel value="#{bundle['survey.settings.end.message.title.sms.enabled.sms.text']}"
                                   for="endSmsText"/>

                    <h:panelGrid columns="1">
                      <eye:inputText id="endSmsText"
                                     maxlength="70"
                                     rows="3"
                                     value="#{surveySettingsController.survey.details.endSmsText}"/>
                      <h:outputText id="couponHint"
                                    value="#{bundle['survey.settings.end.message.coupon.hint']}"/>
                    </h:panelGrid>

                    <!-- Originating address disabled (ips-228) -->
                    <h:panelGroup rendered="false">
                      <h:outputLabel value="#{bundle['survey.settings.end.message.title.sms.number']}"
                                     for="endSmsFrom"/>
                      <eye:inputText id="endSmsFrom"
                                     maxlength="70"
                                     value="#{surveySettingsController.survey.details.endSmsFrom}"/>
                    </h:panelGroup>
                  </h:panelGrid>

                  <eye:buttons>
                    <eye:button>
                      <h:commandLink styleClass="button-green btnSubmit"
                                     value="#{bundle['survey.settings.save']}"
                                     action="#{surveySettingsController.saveMessage}">
                        <f:param name="errorId" value="endMessageDialog"/>
                      </h:commandLink>
                    </eye:button>
                    <eye:button>
                      <h:outputLink styleClass="button-green"
                                    value="#"
                                    onclick="return page.onEditEndMessageCancel();">
                        <h:outputText value="#{bundle['survey.create.button.cancel']}"/>
                      </h:outputLink>
                    </eye:button>
                    <eye:space/>
                  </eye:buttons>
                </h:panelGroup>
              </h:panelGroup>
            </eye:collapsingGroup>

          </h:panelGroup>

          <h:panelGroup layout="block" styleClass="page-footer"/>

        </h:panelGroup>


        <!--
            Survey delete confirmation dialog
        -->
        <ips:confirmDialog id="deleteDialog"
                           text="#{bundle['survey.settings.delete.prompt']}"
                           title="#{bundle['survey.settings.delete.title']}"
                           action="#{surveySettingsController.deleteSurvey}"
                           width="450"/>


        <!--
            Question delete confirmation dialog
        -->
        <eye:dialog id="questionDeleteDialog"
                    title="#{bundle['survey.settings.questions.delete.title']}"
                    width="400">

          <h:panelGroup styleClass="confirmDialog_content"
                        layout="block">
            <h:outputText value="#{surveySettingsController.questionDeletePrompt}"
                          escape="false"/>
          </h:panelGroup>

          <h:panelGroup layout="block" style="margin:10px"/>

          <eye:buttons>
            <eye:button>
              <h:commandLink id="questionDeleteDialog_confirmButton"
                             styleClass="button-green"
                             value="#{bundle['dialog.confirm']}"
                             action="#{surveySettingsController.deleteQuestion}">
                <f:param name="errorId" value="questionDeleteDialog"/>
              </h:commandLink>
            </eye:button>

            <eye:button>
              <h:commandLink id="questionDeleteDialog_cancelButton"
                             styleClass="button-green"
                             value="#{bundle['dialog.cancel']}"
                             onclick="jsfc('questionDeleteDialog').hide(); return false;"/>
            </eye:button>
            <eye:space/>
          </eye:buttons>

        </eye:dialog>

        <!--
            External link delete confirmation dialog
        -->
        <eye:dialog id="extLinkDeleteDialog"
                    title="#{bundle['survey.settings.ext.links.delete.title']}"
                    width="400">

          <h:panelGroup styleClass="confirmDialog_content" layout="block">
            <h:outputText value="#{surveySettingsController.extLinkDeletePrompt}" escape="false"/>
          </h:panelGroup>

          <h:panelGroup layout="block" style="margin: 10px"/>

          <eye:buttons>
            <eye:button>
              <h:commandLink id="extLinkDeleteDialog_confirmButton"
                             styleClass="button-green"
                             value="#{bundle['dialog.confirm']}"
                             action="#{surveySettingsController.deleteExtLink}">
                <f:param name="errorId" value="extLinkDeleteDialog"/>
              </h:commandLink>
            </eye:button>

            <eye:button>
              <h:commandLink id="extLinkDeleteDialog_cancelButton"
                             styleClass="button-green"
                             value="#{bundle['dialog.cancel']}"
                             onclick="jsfc('extLinkDeleteDialog').hide(); return false;"/>
            </eye:button>
            <eye:space/>
          </eye:buttons>

        </eye:dialog>

        <!--
            Question modification dialog
        -->
        <eye:dialog id="questionModificationDialog"
                    title="#{bundle['survey.settings.question.modify.title']}"
                    width="700">

          <h:outputLabel value="#{bundle['survey.settings.question.modify.text']}:"
                         for="title"/>
          <eye:inputText id="title"
                         rows="2"
                         maxlength="70"
                         value="#{surveySettingsController.question.title}"/>

          <br/>

          <h:panelGroup id="headerBlock" layout="block">
            <h:panelGrid columns="5"
                         columnClasses="questionColDrag, questionColId, questionColTitle, questionColNext, questionColAdd">
              <h:outputText value=" "/>
              <h:outputText value=" "/>

              <h:outputText value="#{bundle['question.option.label']}"/>
              <h:outputText value="#{bundle['question.option.next']}"/>
              <h:outputText value=" "/>
            </h:panelGrid>
          </h:panelGroup>


          <h:panelGroup id="scrollableVariants" layout="block">

            <eye:dynamicTable id="questionOptions"
                              value="#{surveySettingsController.questionOptions}"
                              tableClass="table-narrow dtable"
                              dragRows="true">
              <eye:textColumn name="id"
                              allowEmpty="true"
                              columnClass="hidden"/>
              <eye:textColumn name="answer"
                              allowEditAfterAdd="true"
                              allowEmpty="false"
                              columnClass="answerColumn"
                              maxLength="70"/>

              <eye:selectColumn name="nextQuestion"
                                values="#{surveySettingsController.nextQuestionsList}"
                                var="t2" itemLabel="#{t2.label}" itemValue="#{t2.value}"
                                itemDescription="#{t2.description}"
                                allowEditAfterAdd="true"
                                columnClass="nextColumn"/>

            </eye:dynamicTable>
          </h:panelGroup>

          <h:outputLabel value="#{bundle['survey.settings.question.modify.default.question']}: "
                         for="defaultQuestion"/>

          <h:selectOneMenu id="defaultQuestion" value="#{surveySettingsController.defaultQuestionId}">
            <f:selectItems value="#{surveySettingsController.defaultQuestionsList}"/>
          </h:selectOneMenu>

          <br/>
          <br/>

          <eye:buttons>
            <eye:button>
              <h:commandLink id="saveQuestionLink"
                             styleClass="button-green btnSubmit"
                             value="#{bundle['survey.settings.question.modify.save']}"
                             onclick="return page.onQuestionSave('#{bundle['question.option.answer.empty']}');"
                             action="#{surveySettingsController.saveQuestion}">
                <f:param name="errorId" value="questionModificationDialog"/>
              </h:commandLink>
            </eye:button>
            <eye:button>
              <h:commandLink styleClass="button-green"
                             value="#{bundle['survey.settings.question.modify.cancel']}"
                             onclick="return page.onDialogCancel('questionModificationDialog');"/>
            </eye:button>
            <eye:space/>
          </eye:buttons>

        </eye:dialog>

        <!--
            External link modification dialog.
        -->
        <eye:dialog id="extLinkModificationDialog"
                    title="#{bundle['survey.settings.ext.link.modify.title']}"
                    width="700">

          <h:outputLabel value="#{bundle['survey.settings.ext.link.modify.service.name']}:"
                         for="serviceName"/>
          <eye:inputText id="serviceName"
                         maxlength="70"
                         value="#{surveySettingsController.extLinkPage.serviceName}"/>
          <br/>

          <h:outputLabel value="#{bundle['survey.settings.ext.link.modify.service.url']}:"
                         for="serviceUrl"/>
          <eye:inputText id="serviceUrl"
                         maxlength="255"
                         value="#{surveySettingsController.extLinkPage.serviceUrl}"/>
          <br/>

          <eye:buttons>
            <eye:button>
              <h:commandLink id="saveExtLink"
                             styleClass="button-green btnSubmit"
                             value="#{bundle['survey.settings.ext.link.modify.save']}"
                             action="#{surveySettingsController.saveExtLink}">
                <f:param name="errorId" value="extLinkModificationDialog"/>
              </h:commandLink>
            </eye:button>
            <eye:button>
              <h:commandLink styleClass="button-green"
                             value="#{bundle['survey.settings.ext.link.modify.cancel']}"
                             onclick="return page.onDialogCancel('extLinkModificationDialog');"/>
            </eye:button>
            <eye:space/>
          </eye:buttons>
        </eye:dialog>

        <!-- Survey preview dialog -->
        <eye:dialog id="surveyPreviewDialog"
                    title="#{bundle['survey.settings.preview.title']}"
                    width="400">

          <h:outputText value="#{bundle['survey.settings.preview.text']}"/>

          <h:panelGrid columns="2" style="padding-top: 10px">
            <h:outputLabel for="previewPhone"
                           value="#{bundle['survey.settings.preview.phone']}:"/>
            <eye:inputText id="previewPhone"
                           value="#{surveySettingsController.phoneNumber}"/>
          </h:panelGrid>

          <eye:buttons>
            <eye:button>
              <h:commandLink styleClass="button-green"
                             value="#{bundle['survey.settings.preview.ok']}"
                             action="#{surveySettingsController.sendPreview}">
                <f:param name="errorId" value="surveyPreviewDialog"/>
              </h:commandLink>
            </eye:button>
            <eye:button>
              <h:commandLink styleClass="button-green"
                             value="#{bundle['survey.settings.preview.cancel']}"
                             onclick="return page.onDialogCancel('surveyPreviewDialog');"/>
            </eye:button>
            <eye:space/>
          </eye:buttons>

        </eye:dialog>

        <!-- Survey preview via Telegram dialog -->
        <eye:dialog id="surveyTelegramPreviewDialog"
                    title="#{bundle['survey.settings.preview.title']}"
                    width="400">

          <h:outputText value="#{bundle['survey.settings.preview.telegram.text']}: "/>

          <h:outputLink id="previewTelegram"
                        value="https://telegram.me/#{surveySettingsController.survey.statistics.telegramUsername}"
                        target="_blank">
            <h:outputText value="@#{surveySettingsController.survey.statistics.telegramUsername}"/>
          </h:outputLink>

          <eye:buttons>
            <eye:button>
              <h:commandLink styleClass="button-green"
                             value="#{bundle['survey.settings.preview.telegram.ok']}"
                             onclick="return page.onDialogCancel('surveyTelegramPreviewDialog');"/>
            </eye:button>
          </eye:buttons>

        </eye:dialog>

      </h:form>

    </ui:define>

  </ui:composition>

</f:view>